\documentclass{article}

\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{listings}
\usepackage{parskip}

\title{Calibration Constants Database (CCDB) package documentation \\
~\\
\large GlueX-doc-1015-v2
}
\author{Mark M.\ Ito, Dmitry A. Romanov \\
Thomas Jefferson National Accelerator Facility \\
12000 Jefferson Avenue \\
Newport News, VA 23606
}
\date{June 15, 2012}

% global parameters
\textwidth=6.5in
\oddsidemargin=0in % use built-in offset of 1 inch for left margin
\evensidemargin=0in % ditto for even pages
\textheight=9in
\topmargin=0in
\headheight=0in % no headers in this document
\headsep=0in

\begin{document}

\bibliographystyle{plain}

\maketitle

\begin{abstract}
This note contains a documentation of the CCDB package. A package for storing 
and managing calibration constants database.
\end{abstract}

\tableofcontents


%==============================================================================
%    I N T R O D U C T I O N 
%==============================================================================
\newpage
\section{Introduction}

%\begin{figure}
%  \includegraphics[width=\textwidth]{ccdb_overall_tasks.eps}\\
%  \caption{CCDB area of usage}\label{fig:ccdb_overall_tasks}
%
%\end{figure}

Calibration Constants Database (CCDB) aims the next goals:
\begin{itemize}
  \item Storing calibration constants.
  \item Managing calibrations.
  \item API for JANA, plain C++, Python.
  \item Additional Logging, import, export data.
\end{itemize}
\vspace{1 em}

CCDB stores data as tables with columns and rows. As a data storage CCDB supports:
\begin{itemize}
\item \textbf{Naming}. Each table is identified by path-name;
\item \textbf{Versioning}. Each table may has many versions of data;
\item \textbf{Branching}. So called "variations" allows to use branches of data;
\end{itemize}
\vspace{1 em}

As a management tool and as a data provider CCDB allows:
\begin{itemize}
\item C++ User API. Allows an easy access to CCDB data from C++.
\item JANA API. An integration to JANA framework.
\item Python API. Allows accessing and managing CCDB from python language.
\item Command line tools. Tools to manage CCDB data from the shell.
\item Web interface.
\end{itemize}
\vspace{1 em}



%==============================================================================
%    B A S I C   C O N C E P T S
%==============================================================================
\newpage
\section{Basic concepts}\label{sec:basic_concepts}

CCDB basic usage concepts and ccdb console tool for managing CCDB contents


% Data structure
%******************************************************************************
\subsection{Data structure}


% Namepath
%******************************************************************************
\subsection{Namepath}
The desired set of values is identified by name. The name string is unique 
across all detector systems. The convention already implemented in the GlueX 
code base is to use a forward slash(/) notation to specify a hierarchical 
namepath. 

For example:
\begin{verbatim}
/FDC/driftvelocity/timewalk_parameters
\end{verbatim}

This allows implementors of individual detector systems to to specify a 
hierarchy with as much or little depth as is needed given their complexity.
The "/FDC/driftvelocity/timewalk\_parameters" parameters may have members 
identified by either name or position. For example, it may contain 3 values: 
"slope", "offset", and "exponent". By contrast, a set of constants with a 
namepath "/FDC/CathodeStrips/pedestals" may have 100 values identified simply 
as "0", "1", "2", "3", ...

\textbf{Namepath format}:\\
Allowed symbols are a-z, A-Z, 0-9, \_ and -. There is no space or special symbols
allowed in the namespath. Such considerations simplifies the console management
and database validation of namepath objects.


% Variations
%******************************************************************************
\subsection{Variation}
The CCDB includes a \textit{variation} feature. The variation is a sort 
of data branching, making a "shallow copy" of a complete set of calibration 
constants (i.e. one that refers to constants without actually copying them). 

The variation is to be used primarily to create a new set of constants based
on another set, but with a few changes. A variation is identified as a string. 
The primary purpose of a variation is to allow testing of new constants or
alternative sets of constants that don't disturb the main trunk and don't 
require copying a complete set.

Specifying a is optional for end-users. If no variation is specified, then a
"\textit{default}" variation is used. It is assumed that the default variation 
will be used to hold the best available constants at any point in time. 

Each variation is stored in the CCDB with information regarding another 
variation upon which it is based. This basis variation may specify the default variation.

Each set of constants in the CCDB includes a variation string that is used to
specify which variation those specific constants are valid for.

\textbf{Variations format}:\\
Allowed symbols are a-z, A-Z, 0-9, \_ and -. There is no space or special symbols
allowed in variation name. Such considerations simplifies the console management
and database validation of variation names.


% Data requests
%******************************************************************************
\subsection{Data requests}

There are two problems related to data access, CCDB tries to solve:
\begin{enumerate}
  \item Getting constants should be as easy as to say 
        "Give me this constants for June 2011"

  \item There should be one way to give an unique key for every set of data.
  \footnote{
    The first thing that comes to mind when one hears "unique key" might be
    "lets use incremental indexes". But CCDB is database independent. Indexes
    which are good to use with databases become uneasy for standalone ACSII 
    files. Moreover, moving indexes from one database to another might be a 
    problem. And, last but not least, indexes are good for machines. If an 
    operator has an index 1114211 it tells nothing to him and could be easily
    mistaken with 1142111 which belong to absolutely another data set.
  }
\end{enumerate}
\vspace{1 em}

CCDB uses so called "Requests" to solve both of the problems.
The full form of the request is an "unique composite key" for
the particular data values.

Full form of the request is
\begin{verbatim}
    </path/to/data>:<run>:<variation>:<time>
\end{verbatim}
\vspace{1 em}

To get the data user can specify only a part of the request.
The minimal request to get the data is just /path/to/data
One may omit any part of the request except for name-path.

Lets look at examples:
\begin{itemize}
\item /path/to/data - no run, variation or timestamp is specified
\item /path/to/data::mc - no run specified, variation is "mc", no date is specified
\item /path/to/data:::2029 - only the path and the date(year) are specified
\end{itemize}

As shown in the examples above, to specify a path and a variation but 
to use default run one skips the run number and leave its place like "::"
\begin{verbatim}
                   +-- variation
                   |
                   |
   /path/to/data::mc
                ^
                |
                +-- place where run number should be
\end{verbatim}


And the request '/path/to/data:::2029' means that we specify a path and a date
but leave a run number and a variation to be set by default.
What does word 'default' means? We will discuss it in "DEFAULT VALUES" chapter.

The time is parsed as:
    \textbf{YYYY:MM:DD-hh:mm:ss}

Any non digit character may be used as separator instead of ':' and '-'

so all these data lines are the same
\begin{verbatim}
    2029/06/17-22:03:05
    2029-06-17-22-03-05
    2029/06/17:22/03/05
    2029a06b17c22d03e05
\end{verbatim}

One can omit any part of the time string starting from the right, this the latest 
date for this part will be returned.

Examples:

"2011" - (this means the year 2011), it will be interpreted as 
2011/12/31-23:59:59 timestamp so the latest constants for year 
2011 will be returned.


"2012/05/21" - it will be interpreted as 2012/05/21-23:59:59 meaning to be the 
latest constants for 21 May 2012

CCDB searches the closest constants before or equal to timestamp provided.


% Examples
%******************************************************************************
\subsection{Examples}

This chapter will provide users with practical examples of all above. 
Text is to be written.  

\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\textwidth]{pics/variations_example1}
  \caption{Variations basic usage}
\end{figure}




% Default values
%******************************************************************************
\subsection{Default values}

There are two general cases of using the requests:
\begin{enumerate}
  \item In physics software to read out constants
  \item When one manages constants (with ccdb console, python or other)
\end{enumerate}
\vspace{1 em}

In the first case most probably the software will know and provide the run 
number being processed. Also, most probably, the software should allow to set 
the variation to prefer for the analysis.

So, CCDB defaults and priorities (1 - highest)

%Run number:
\textbf{Run number:}
1. Run number specified in a request
(if you use "/path/to/data:100" request, constants for run 100 will be returned 
dependless of the run being processed)
2. Software set global default run number.
(if 10200 run is being processed and you use "/path/to/data" data for run \# 10200 will be returned)
3. 0 - (means run number 0).

%Variation
\textbf{Variation:}
1. Variation specified in a request
(if you use "/path/to/data::mc" request, constants for variation mc will be used)
2. Global preferred variation set by software.
(...)
3. the "default" variation.


%Time stamp
\textbf{Timestamp:}
1. Request specified time will be used
2. Current time

When one uses ccdb console tool in interactive mode, one can set the default run number by running 'run' command

Example:
\begin{verbatim}
> run 100
> cat /path/to/data     # all commands will get constants for run 100
> run                   # you can check what run is set by default
100
\end{verbatim}
C++ API section will overview how to set defult run


% Connection strings
%******************************************************************************
\subsection{Connection strings}\label{sec:connection}


CCDB uses so called "connection strings" to specify a data source.
The generic format of a connection string is:
\begin{verbatim}
    <protocol>://<datasource specified string>
\end{verbatim}

MySQL connection string:
\begin{verbatim}
mysql://<username>:<password>@<server_address>:<port> <database>
\end{verbatim}

One may omit any part except "mysql://" and "<server\_address>". The default
values will be used.

CCDB MySQL connection defaults:
\begin{itemize}
  \item username - ccdb\_user
  \item password - no password
  \item port - default MySQL port (now is 3306)
  \item database - ccdb
\end{itemize}


Here is the order of how ccdb gets the connection string:
\begin{enumerate}
  \item The default connection string is  \textbf{"mysql://ccdb\_user@localhost ccdb"}

  \item if \textbf{CCDB\_CONNECTION} environment variable is set it is used overwriting
        the default connection string

  \item if -c or --connection flag is given in command promt it is used overwriting
        all other.
\end{enumerate}

Example 3. Connection string 1:

\begin{verbatim}
        "mysql://john@localhost:999"
\end{verbatim}


\begin{itemize}
  \item MySQL server on 'localhost' using port 999
  \item user is 'john' with no password
  \item the database is 'ccdb' by default
\end{itemize}

Example 4. Simple connection string:
\begin{verbatim}	
	"mysql://localhost"
\end{verbatim}

\begin{itemize}
  \item MySQL server on localhost using port 3306 (default)
  \item user is 'ccdb\_user' with no password (default)
  \item the database is 'ccdb' (default)
\end{itemize}


Example 5. Full connection string:
\begin{verbatim}	
        "mysql://smith:hHjD83f@192.168.1.3:4444 ccdb_database"
\end{verbatim}

It tells ccdbcmd to connect to:
\begin{itemize}
  \item MySQL server  on '192.168.1.3' using port 4444
  \item user is 'smith' with password 'hHjD83f'
  \item the database is 'ccdb\_database'
\end{itemize}


% Update and delete operations
%******************************************************************************
\subsection{Update and delete operations}

CCDB follows two principles in terms of updating and deleting:
\begin{enumerate}
\item Don't delete anything.
\item Updates are done by '\textit{adding new}'.
\end{enumerate}

If one wants to \textit{update} the values of some table, it is done by 
\textit{adding a new} set of constants. The software will use more recent set 
of data by default. 

If one wants to change the number of columns of the table (or columns 
specification), it is done by adding a new table with a new name. 

For example. If one wants to change the format of a table:
\begin{verbatim}
/FDC/driftvelocity/timewalk_parameters
\end{verbatim}
One should create a new table with right format:
\begin{verbatim}
/FDC/driftvelocity/timewalk_parameters2
\end{verbatim}

CCDB doesn't provide any tools for deleting \textbf{\textit{non empty}} tables 
or directories, changing their names or specifications at user level. 

There is a strong reason for this limitation. 
If CCDB is used to hold calibration constants, then some code should exist for 
each data set. At least somewhere at some point of time. So deleting  
or changing something (the number of rows in a table for example) will lead to 
corruption of the code. The worst case scenario is when such changes don't
lead to immediate crush but produce weird hard-to-determine bugs somewhere in 
deep parts of an offline software.

(Deleting an empty table is OK - there is no data so no code behind it)


If one really need to delete some constants, this should be done at 
\textit{administrative level}. This means that is should be discussed, users 
should be notified about changes, and the changes should be tested. 
Thus deleting the constants shouldn't become a normal every day experience 
for users.

%==============================================================================
%    C O M M A N D   L I N E   T U T O R I A L
%==============================================================================
\newpage
\section{CCDB command line tutorial}\label{sec:console_tools_tutorial}

This section is a tutorial of using CCDB command line tools.


%Getting started
%******************************************************************************
\subsection {Getting started}

CCDB provides command line tools which is useful for introspection and 
management of constants database. One can run it by typing 'ccdb' command.
'ccdb' has two modes: it can be used as an interactive shell or as 
a single command.
\vspace{1 em}


Usage from command line:
\begin{verbatim}
     ccdb <ccdb arguents> command <command arguments>
\end{verbatim}
\vspace{1 em}

Usage as interactive shell:
\begin{verbatim}
     ccdb <ccdb arguments> -i
     > command1
     > command2
     > ...
     > q
\end{verbatim}
\vspace{1 em}


Example 1. Command line mode:
\begin{verbatim}
                (1)                        (2)    (3)
      ccdb -c "mysql://john@localhost:999" ls /TOF/params

\end{verbatim}
\vspace{1 em}


\begin{enumerate}
\item \textbf{-c "mysql://john@localhost"} - sets the ccdb connection string. 
      If -c flag is not given, ccdb will try CCDB\_CONNECTION environment 
      variable, if CCDB\_CONNECTION  default connection string. The connection
      strings are described in ~\ref{sec:connection}

\item ls - is a ccdb command which returns a list of directories and tables
      that belongs to directory '/TOF/params'

\item /TOF/params - is the argument of ls command. Like a posix shell ls.
\end{enumerate}
\vspace{1 em}


Example 2. Interactive mode:
\begin{verbatim}
      ccdbcmd -i -c "mysql://john@localhost:999"               (1)
      > ls /TOF/params                                         (2)
      > help                                                   (3)
      > cd /TOF                                                (4)
      > cd params
      > ls
      > pwd                                                    (5)
      > q                                                      (6)
\end{verbatim}


\begin{enumerate}
  \item flag '-i'  will start ccdb in interactive mode.

  \item 'ls /TOF/params' - the result of the is exactly the same as in Example 1.
         One stays in the interactive shell after the execution.

  \item 'help' command provides list of commands and how to use each of them

  \item executing next commands will reproduce Example 1 step by step.

  \item  The same as in posix shell, ccdb interactive mode have the current 
         working directory, with relative and absolute pathes. 
         pwd command shows the current working directory.

  \item to exit interactive mode enter 'q', 'quit' or press ctrl+D
\end{enumerate}

Since ccdb objects have /name/paths and many other things that looks like
POSIX file system, the commands are very posix-shell-like.


%******************************************************************************
\subsection{Help system}

The ccdb is designed to be a self descriptive. By using 'help' 'usage' and 'example' commands
one could get all the commands and how to use them.

By using 'howto' command one could get tutorials for typical situations.


%******************************************************************************
\subsection{Commands}

\subsubsection{Commands consistency}

Command keys are consistent. This means that some flags and argument formats
are the same across all commands. There are unified flags to identify objects for all commands:
\begin{itemize}
  \item \textbf{-v} - Variation
  \item \textbf{-t} - Data table
  \item \textbf{-r} - Run or run-range
  \item \textbf{-d} - Directory
\end{itemize}

For example '\textbf{info}' command may be executed against directory, table or variation.
Example 6. Info command:
\begin{verbatim}
[bash promt] ccdb -i
     > info -v default                                          (1)
     > info -r all                                              (2)
     > info -d /TOF                                             (3)
     > info -t /TOF/params                                      (4)
     > info /TOF/params                                         (5)
\end{verbatim}

1. Get information about "default" variation
2. Get information about "all" runrange. "all" runrange is [0, infinite\_run]
3. Get information about "/TOF" directory.
4. Get information about "/TOF/params" type table
5. By default '*info*' treat non flag argument as a name of a table.

\subsubsection{Commands overview}

This table is printed if one executes "ccdb help"
\begin{table}[position specifier]
\centering
\begin{tabular}{| l | l | l |}
  \hline
  % after \\: \hline or \cline{col1-col2} \cline{col3-col4} ...
  info   & Info          & Prints extended information about an object \\
  vers   & Versions      & Show versions of data for the specified table \\
  run    & CurrentRun    & Gets or sets current working run \\
  dump   & Dump          & Dumps data table to a file \\
  show   & Show          & Shows type table data \\
  mkdir  & MakeDirectory & Create directory \\
  pwd    & PrintWorkDir  & Prints working directory \\
  cd     & ChangeDir     & Change current directory \\
  add    & AddData       & Add data constants \\
  mktbl  & MakeTable     & Create constants type table \\
  cat    & Cat           & Show assignment data by ID \\
  ls     & List          & List objects in a given directory \\
  \hline
\end{tabular}
\caption{List of ccdb commands}
\label{tab:commands}
\end{table}

Assuming that user is in interactive mode, one may categorize the commands:


\emph{To navigate directories}
pwd - prints curent directory
cd  - switch to specified directory
ls  - list objects in the directory (wildcards are allowed)
mkdir - creates directory

Example 7. Directory commands overview:
\begin{verbatim}
    > pwd
    /
	> cd /TOF
	> ls
    table1  table2
	> mkdir constants
	> ls con*
    constants
\end{verbatim}



\textbf{Get information about objects}
\begin{itemize}
  \item \textbf{info} - gets information about objects (use -v -r -d flags), see example 6.
  \item \textbf{vers} - gets all versions of the table
  \item \textbf{cat}  - displays values
  \item \textbf{dump} - same as cat but dumps files to disk
  \item \textbf{logs} - see logs information
\end{itemize}


\textbf{Manage objects}
\begin{itemize}
  \item \textbf{mkdir} - creates directory
  \item \textbf{mktbl} - creates data table
  \item \textbf{add} - adds data from text file to table
        (variation and runranges are created automatically by add command)
\end{itemize}





\bibliography{ccdb_doc}

\end{document}
